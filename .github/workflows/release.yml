name: Release

on:
  push:
    tags: ['v*']
  workflow_dispatch:
    inputs:
      publish_crates:
        description: 'Publish to crates.io'
        required: true
        type: boolean
        default: false

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    name: Build ${{ matrix.target }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-latest
            cross: true

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross
        if: matrix.cross
        run: cargo install cross --git https://github.com/cross-rs/cross

      - name: Build
        run: |
          if [ "${{ matrix.cross }}" = "true" ]; then
            cross build --release --target ${{ matrix.target }}
          else
            cargo build --release --target ${{ matrix.target }}
          fi

      - name: Package
        run: |
          DIRNAME="atm-${{ github.ref_name }}"
          mkdir "$DIRNAME"
          cp target/${{ matrix.target }}/release/atm "$DIRNAME/"
          cp target/${{ matrix.target }}/release/atmd "$DIRNAME/"
          cp crates/atm/scripts/atm-hook "$DIRNAME/"
          chmod +x "$DIRNAME"/*
          tar -czvf "atm-${{ matrix.target }}.tar.gz" "$DIRNAME"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: atm-${{ matrix.target }}
          path: atm-${{ matrix.target }}.tar.gz

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            artifacts/**/atm-*.tar.gz
            scripts/install.sh
          generate_release_notes: true

  publish:
    name: Publish to crates.io
    runs-on: ubuntu-latest
    # Only run on manual trigger with publish_crates=true
    if: github.event_name == 'workflow_dispatch' && inputs.publish_crates

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Verify crate builds
        run: cargo build --release

      - name: Publish crates in dependency order
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          set -e

          # Get crate version from workspace (fails if crate not found)
          get_version() {
            local version
            version=$(cargo metadata --format-version 1 --no-deps | jq -r ".packages[] | select(.name == \"$1\") | .version")
            if [ -z "$version" ]; then
              echo "::error::Crate '$1' not found in workspace" >&2
              return 1
            fi
            echo "$version"
          }

          # Check if crate@version is already on crates.io
          is_published() {
            local crate=$1
            local version=$2
            # Use crates.io API - more reliable than cargo search (30s timeout)
            local status=$(curl -s --max-time 30 -o /dev/null -w "%{http_code}" "https://crates.io/api/v1/crates/$crate/$version")
            [ "$status" = "200" ]
          }

          # Publish a crate, skipping if already published
          publish_crate() {
            local crate=$1
            local version=$(get_version "$crate")

            echo "::group::$crate@$version"

            if is_published "$crate" "$version"; then
              echo "âœ“ Already published, skipping"
              echo "::endgroup::"
              return 0
            fi

            echo "Publishing..."
            local output
            if output=$(cargo publish -p "$crate" 2>&1); then
              echo "$output"
              echo "âœ“ Published successfully"
              echo "::endgroup::"
              return 0
            fi

            # Check if error was "already exists" (crates.io index was slow)
            echo "$output"
            if echo "$output" | grep -q "already exists"; then
              echo "âœ“ Already published (detected from cargo error)"
              echo "::endgroup::"
              return 0
            fi

            echo "âœ— Failed to publish"
            echo "::endgroup::"
            return 1
          }

          # Wait for crate to appear in index (needed for dependents)
          wait_for_crate() {
            local crate=$1
            local version=$(get_version "$crate")
            local max_wait=120
            local waited=0

            echo -n "Waiting for $crate@$version in index"
            while [ "$waited" -lt "$max_wait" ]; do
              if is_published "$crate" "$version"; then
                echo " âœ“"
                return 0
              fi
              echo -n "."
              sleep 5
              waited=$((waited + 5))
            done
            echo " timeout"
            echo "::error::Timeout waiting for $crate@$version in crates.io index"
            return 1
          }

          # Publish in dependency order
          # Layer 1: No dependencies
          publish_crate atm-core || exit 1
          wait_for_crate atm-core || exit 1

          # Layer 2: Depends on atm-core
          publish_crate atm-protocol || exit 1
          wait_for_crate atm-protocol || exit 1

          # Layer 3: Depends on atm-core and atm-protocol (can run in parallel)
          publish_crate atm-tui &
          pid_tui=$!
          publish_crate atmd &
          pid_atmd=$!

          # Wait for both and check results
          wait $pid_tui || exit 1
          wait $pid_atmd || exit 1

          wait_for_crate atm-tui || exit 1
          wait_for_crate atmd || exit 1

          # Layer 4: Depends on all above
          publish_crate atm || exit 1

          echo ""
          echo "ðŸŽ‰ All crates published successfully!"
